<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarNote Online | ‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-dark: #1f2937; /* Dark Blue-Gray */
            --secondary-dark: #374151; /* Slightly lighter dark */
            --accent-orange: #f97316; /* Bright Orange */
            --text-light: #e5e7eb; /* Light gray text */
            --text-dark: #111827; /* Very dark text */
            --bg-light: #f9fafb; /* Off-white background */
            --border-color: #e5e7eb;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 50px;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        /* --- Navigation Bar --- */
        nav {
            background-color: var(--primary-dark);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        nav h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: -0.5px;
            color: var(--accent-orange);
            font-weight: 800;
        }
        .nav-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background-color: var(--accent-orange);
            border-color: var(--accent-orange);
            transform: translateY(-2px);
        }
        .nav-btn.logout {
            background-color: var(--danger);
            border-color: var(--danger);
        }
        .nav-btn.logout:hover {
            background-color: #dc2626;
            border-color: #dc2626;
        }

        .container {
            width: 92%;
            max-width: 800px;
            margin: 30px auto;
        }

        /* --- Admin Panel --- */
        #adminPanel {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 40px;
            display: none;
            border: 2px solid var(--accent-orange);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        #adminPanel h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--primary-dark);
            text-align: center;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        input[type="text"], select {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--text-dark);
            background-color: var(--bg-light);
            transition: border-color 0.3s ease;
        }
        input[type="text"]:focus, select:focus {
            border-color: var(--accent-orange);
            outline: none;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        /* Custom File Input Styling */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-label {
            display: block;
            padding: 14px 20px;
            background-color: var(--bg-light);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--gray);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .file-label:hover {
            background-color: #e2e8f0;
            border-color: var(--accent-orange);
        }
        input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        #imagePreview {
            width: 100%;
            height: 180px;
            object-fit: contain;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 10px;
            display: none; /* Hide by default */
        }
        #progressText {
            text-align: center;
            font-size: 0.9rem;
            color: var(--accent-orange);
            margin-top: 10px;
            font-weight: 600;
        }

        .btn-action {
            width: 100%;
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-action:hover {
            background-color: #ea580c;
            transform: translateY(-2px);
        }
        .btn-action:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Car Card Layout --- */
        .car-card {
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 40px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            position: relative;
            transition: transform 0.3s ease;
        }
        .car-card:hover {
            transform: translateY(-8px);
        }
        .status-tag {
            position: absolute;
            top: 18px;
            left: 18px;
            padding: 8px 18px;
            border-radius: 50px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .tag-available { background-color: var(--success); }
        .tag-sold { background-color: var(--danger); }
        
        .car-img {
            width: 100%;
            height: 320px;
            object-fit: cover;
            background-color: #eee;
        }
        .car-details {
            padding: 25px;
        }
        .car-details h2 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .price-tag {
            font-size: 2.2rem;
            color: var(--accent-orange);
            font-weight: 800;
            margin: 10px 0 15px 0;
            letter-spacing: -1px;
        }
        .admin-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }
        .btn-delete-post {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-delete-post:hover {
            background-color: #dc2626;
        }

        /* --- Comment Section --- */
        .comment-section {
            background-color: var(--bg-light);
            padding: 20px;
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 20px 20px;
        }
        .comment-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .comment-input-group input {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            background-color: white;
        }
        .comment-input-group button {
            background-color: var(--primary-dark);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .comment-input-group button:hover {
            background-color: var(--secondary-dark);
        }
        .comment-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .comment-item {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border-left: 4px solid var(--accent-orange);
            font-size: 0.9rem;
        }
        .comment-item strong {
            color: var(--primary-dark);
            font-weight: 600;
        }
        .comment-item span {
            color: var(--gray);
            font-size: 0.85rem;
            margin-left: 8px;
        }
        .comment-text {
            display: block;
            margin-top: 8px;
            color: var(--text-dark);
        }
        .btn-delete-comment {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }
        .btn-delete-comment:hover {
            background-color: #dc2626;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 600px) {
            nav {
                padding: 10px 3%;
            }
            nav h1 {
                font-size: 1.4rem;
            }
            .nav-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            .container {
                width: 95%;
                margin: 20px auto;
            }
            #adminPanel, .car-card {
                padding: 20px;
                border-radius: 15px;
            }
            #adminPanel h3 {
                font-size: 1.3rem;
            }
            .car-img {
                height: 250px;
            }
            .car-details h2 {
                font-size: 1.5rem;
            }
            .price-tag {
                font-size: 1.8rem;
            }
            .comment-section {
                padding: 15px;
            }
            .comment-item {
                padding: 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>

<nav>
    <h1>CARNOTE ONLINE</h1>
    <button id="adminBtn" class="nav-btn" onclick="handleAdmin()">‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
</nav>

<div class="container">
    <div id="adminPanel">
        <h3>‚ú® ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏£‡∏ñ (Admin Panel)</h3>
        <div class="form-group">
            <input type="text" id="carTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ / ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô Honda Civic 2023)">
        </div>
        <div class="form-group">
            <input type="text" id="carPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô 590,000)">
        </div>
        
        <div class="form-group">
            <div class="file-upload-wrapper">
                <label for="carFile" class="file-label" id="fileLabel">
                    üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                </label>
                <input type="file" id="carFile" accept="image/*" onchange="updateLabelAndPreview()">
            </div>
            <img id="imagePreview" src="#" alt="Image Preview">
        </div>

        <div class="form-group">
            <select id="carStatus">
                <option value="available">üü¢ ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</option>
                <option value="sold">üî¥ ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
            </select>
        </div>
        <button id="uploadBtn" class="btn-action" onclick="startUpload()">üöÄ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        <p id="progressText"></p>
    </div>

    <div id="carList">
        <p style="text-align: center; color: var(--gray); margin-top: 50px; font-size: 1.1rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û...</p>
    </div>
</div>

<script>
    // Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏π‡∏ú‡∏≤
    const firebaseConfig = {
        apiKey: "AIzaSyANA3-UyKf-MS2dcmbAuPGt-KtRd0KTmGw",
        authDomain: "note-communitycar.firebaseapp.com",
        databaseURL: "https://note-communitycar-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "note-communitycar",
        storageBucket: "note-communitycar.appspot.com", 
        messagingSenderId: "387457886547",
        appId: "1:387457886547:web:d7e5f60fb7d2cdbf3ed9a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let isAdmin = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Panel ---
    function handleAdmin() {
        if (!isAdmin) {
            const pass = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:");
            if (pass === "Note#2026!Car@Phupha99") { // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                isAdmin = true;
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminBtn').innerText = "üö™ ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå";
                document.getElementById('adminBtn').classList.add('logout');
                renderCars(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            } else if(pass !== null) { // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Cancel ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏ú‡∏¥‡∏î
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            }
        } else { // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            isAdmin = false;
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminBtn').innerText = "‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
            document.getElementById('adminBtn').classList.remove('logout');
            renderCars(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
        }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    function updateLabelAndPreview() {
        const fileInput = document.getElementById('carFile');
        const fileLabel = document.getElementById('fileLabel');
        const imagePreview = document.getElementById('imagePreview');
        const file = fileInput.files[0];

        if (file) {
            fileLabel.innerText = `‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ: ${file.name}`;
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            fileLabel.innerText = "üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á";
            imagePreview.style.display = 'none';
            imagePreview.src = '#';
        }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå
    async function startUpload() {
        const title = document.getElementById('carTitle').value.trim();
        const price = document.getElementById('carPrice').value.trim();
        const file = document.getElementById('carFile').files[0];
        const status = document.getElementById('carStatus').value;
        const uploadBtn = document.getElementById('uploadBtn');
        const progressText = document.getElementById('progressText');

        if (!title || !price || !file) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏±‡∏ö!");
            return;
        }

        uploadBtn.disabled = true;
        progressText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)";

        try {
            // 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ Firebase Storage
            const storageRef = storage.ref(`car_images/${Date.now()}_${file.name}`);
            const snapshot = await storageRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();

            // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏•‡∏á Realtime Database
            await db.ref('cars').push({
                title,
                price,
                img: downloadURL,
                status,
                createdAt: Date.now()
            });

            alert("‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!");
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('carTitle').value = "";
            document.getElementById('carPrice').value = "";
            document.getElementById('carFile').value = "";
            document.getElementById('fileLabel').innerText = "üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á";
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '#';
            progressText.innerText = "";
            uploadBtn.disabled = false;

        } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            uploadBtn.disabled = false;
            progressText.innerText = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏ñ ---
    function renderCars() {
        db.ref('cars').on('value', snapshot => {
            const list = document.getElementById('carList');
            list.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            const data = snapshot.val();

            if (data) {
                Object.keys(data).reverse().forEach(key => { // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                    const car = data[key];
                    list.innerHTML += `
                        <div class="car-card">
                            <div class="status-tag ${car.status === 'available' ? 'tag-available' : 'tag-sold'}">
                                ${car.status === 'available' ? 'üü¢ ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà' : 'üî¥ ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'}
                            </div>
                            <img src="${car.img}" class="car-img" onerror="this.src='https://via.placeholder.com/800x500?text=CarNote+Online'">
                            <div class="car-details">
                                <h2>${car.title}</h2>
                                <div class="price-tag">‡∏ø ${car.price}</div>
                                ${isAdmin ? `
                                    <div class="admin-options">
                                        <button class="btn-delete-post" onclick="deletePost('${key}', '${car.img}')">üóëÔ∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ</button>
                                        </div>
                                ` : ''}
                            </div>
                            <div class="comment-section">
                                <h4 style="margin-top:0; color: var(--primary-dark);">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h4>
                                <ul id="comments-list-${key}" class="comment-list">
                                    </ul>
                                <div class="comment-input-group">
                                    <input type="text" id="username-${key}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
                                    <input type="text" id="message-${key}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                                    <button onclick="sendComment('${key}')">‡∏™‡πà‡∏á</button>
                                </div>
                            </div>
                        </div>
                    `;
                    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ
                    renderComments(key); 
                });
            } else {
                list.innerHTML = `<p style="text-align: center; color: var(--gray); margin-top: 50px; font-size: 1.1rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>`;
            }
        });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå ---
    // ‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (LocalStorage)
    window.onload = function() {
        const savedName = localStorage.getItem('carnote_user');
        if (savedName) {
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÉ‡∏ô input ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏°‡∏µ input ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            // ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
        }
        renderCars(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏ñ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    };

    function sendComment(carId) {
        const usernameInput = document.getElementById(`username-${carId}`);
        const messageInput = document.getElementById(`message-${carId}`);
        const name = usernameInput.value.trim();
        const msg = messageInput.value.trim();

        if (name && msg) {
            localStorage.setItem('carnote_user', name); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠
            db.ref(`comments/${carId}`).push({
                username: name,
                message: msg,
                timestamp: Date.now()
            });
            messageInput.value = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á
            // usernameInput.value = name; // ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á
        } else {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    function renderComments(carId) {
        db.ref(`comments/${carId}`).on('value', snapshot => {
            const commentList = document.getElementById(`comments-list-${carId}`);
            if (!commentList) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤ element ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
            commentList.innerHTML = "";
            const data = snapshot.val();
            if (data) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                Object.values(data).reverse().forEach(comment => {
                    const li = document.createElement('li');
                    li.className = 'comment-item';
                    const time = new Date(comment.timestamp).toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' });
                    li.innerHTML = `
                        <strong>${comment.username}</strong> <span>${time}</span>
                        <p class="comment-text">${comment.message}</p>
                        ${isAdmin ? `<button class="btn-delete-comment" onclick="deleteComment('${carId}', '${comment.key}')">‡∏•‡∏ö</button>` : ''}
                    `;
                    commentList.appendChild(li);
                });
            } else {
                commentList.innerHTML = `<li style="font-size:0.85rem; color:var(--gray); text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...</li>`;
            }
            // ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á input (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const usernameInput = document.getElementById(`username-${carId}`);
            const savedName = localStorage.getItem('carnote_user');
            if(usernameInput && savedName) {
                usernameInput.value = savedName;
            }
        });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin Only) ---
    async function deletePost(carId, imgUrl) {
        if (!isAdmin) { alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ"); return; }
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ñ‡∏≤‡∏ß‡∏£?")) {
            try {
                // 1. ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Firebase Storage
                if (imgUrl) {
                    const imgRef = storage.refFromURL(imgUrl);
                    await imgRef.delete();
                }
                // 2. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏à‡∏≤‡∏Å Realtime Database
                await db.ref(`cars/${carId}`).remove();
                // 3. ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                await db.ref(`comments/${carId}`).remove();

                alert("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!");
            } catch (error) {
                console.error("Error deleting post:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            }
        }
    }

    async function deleteComment(carId, commentKey) {
        if (!isAdmin) { alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ"); return; }
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ?")) {
            try {
                await db.ref(`comments/${carId}/${commentKey}`).remove();
                alert("‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            } catch (error) {
                console.error("Error deleting comment:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå");
            }
        }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏ñ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    // renderCars(); ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô window.onload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
</script>
</body>
</html>
